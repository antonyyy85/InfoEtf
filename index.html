<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Titolo per ISIN</title>
    <link rel="stylesheet" href="InfoEtf.css">
</head>
<body>
    <div class="container">
        <h1>Ricerca Titolo per ISIN</h1>
        <p class="subtitle">Inserisci il codice ISIN (11 caratteri alfanumerici) per ottenere il valore corrente</p>

        <div class="input-row">
            <input type="text" id="isin" placeholder="Ricerca per isin" maxlength="11" autocomplete="off" spellcheck="false">
            <input type="text" id="searchName" placeholder="Ricerca per nome">
            <button id="searchBtn" onclick="searchISIN()">Cerca</button>
        </div>

        <div class="spinner-wrap" id="spinner">
            <div class="spinner"></div>
            <span>Ricerca in corso...</span>
        </div>

        <div class="card" id="card">
            <div class="card-header">
                <div class="name" id="cardName">-</div>
                <div class="isin-label" id="cardISIN">-</div>
            </div>
            <div class="card-body">
                <div class="price-row">
                    <span class="price" id="cardPrice">-</span>
                    <span class="currency" id="cardCurrency"></span>
                    <span class="change" id="cardChange"></span>
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Apertura</div>
                        <div class="detail-value" id="cardOpen">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Chiusura prec.</div>
                        <div class="detail-value" id="cardPrevClose">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Minimo giornaliero</div>
                        <div class="detail-value" id="cardLow">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Massimo giornaliero</div>
                        <div class="detail-value" id="cardHigh">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Volume</div>
                        <div class="detail-value" id="cardVolume">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Mercato</div>
                        <div class="detail-value" id="cardExchange">-</div>
                    </div>
                </div>
                <div class="actions-row">
                    <button id="addToTableBtn" type="button" onclick="addCurrentResultToTable()" disabled>Aggiungi alla tabella</button>
                </div>
            </div>
        </div>
        <div class="error-box" id="errorBox"></div>

        <div class="saved-section">
            <div class="saved-header">
                <h2 class="saved-title">Titoli salvati</h2>
                <div class="header-right">
                    <span id="lastUpdateLabel" class="last-update"></span>
                </div>
                <div class="header-right">
                    <button id="refreshTableBtn" type="button" onclick="refreshSavedRecords()">Refresh tabella</button>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th class="draggable-header" title="Trascina per riordinare">#</th>
                            <th class="sortable" onclick="setSort('code')">
                                <div class="header-content">Codice</div>
                                <input class="filter-input" id="filterCode" type="text" placeholder="Filtra">
                            </th>
                            <th class="sortable" onclick="setSort('name')">
                                <div class="header-content">Nome</div>
                                <input class="filter-input" id="filterName" type="text" placeholder="Filtra">
                            </th>
                            <th class="sortable" onclick="setSort('pmc')" title="Prezzo medio di carico">
                                <div class="header-content">PMC</div>
                            </th>
                            <th class="sortable" onclick="setSort('priceEur')">
                                <div class="header-content">Prezzo</div>
                            </th>
                            <th class="sortable" onclick="setSort('changePct')" style="text-align: center;">
                                <div class="header-content">% Oggi</div>
                            </th>
                            <th class="sortable" onclick="setSort('pctTotale')">
                                <div class="header-content">% Totale</div>
                            </th>
                            <th class="sortable" onclick="setSort('inv')" title="Totale Investito" style="text-align: center;">
                                <div class="header-content">Inv</div>
                            </th>
                            <th class="sortable" onclick="setSort('diff')" title="Differenza tra Val e Inv">
                                <div class="header-content">Saldo</div>
                            </th>
                            <th class="sortable" onclick="setSort('val')" title="Valore Totale">
                                <div class="header-content">Val</div>
                            </th>
                            <th style="text-align: center;">
                                <div class="header-content">Low-High</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="savedTableBody"></tbody>
                </table>
            </div>
            <!-- Sezioni per mobile -->
            <div class="mobile-cards" id="mobileCards"></div>
        </div>

        <div class="test-box" id="totalsBox">
            <div class="total-row">
                <span class="total-label">Totale Inv:</span>
                <span class="total-value" id="totalInv">-</span>
            </div>
            <div class="total-row">
                <span class="total-label">Totale Val:</span>
                <span class="total-value" id="totalVal">-</span>
            </div>
            <div class="total-row">
                <span class="total-label">Differenza:</span>
                <span class="total-value" id="totalDiff">-</span>
            </div>
        </div>
    </div>

    <!-- Popup per dettagli -->
    <div id="detailPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h3 id="popupTitle"></h3>
                <button class="popup-close" onclick="closePopup()">&times;</button>
            </div>
            <div class="popup-body" id="popupBody"></div>
            <div class="popup-footer">
                <label for="pmcInput">PMC:</label>
                <input type="number" id="pmcInput" step="0.0001" placeholder="Prezzo medio carico">
                <label for="invInput">Inv:</label>
                <input type="number" id="invInput" step="0.0001" placeholder="Numero investitori">
            </div>
            <div class="popup-footer-buttons">
                <button onclick="savePmc()">Salva</button>
                <button class="delete-btn" onclick="deleteRecordFromPopup()">Elimina</button>
            </div>
        </div>
    </div>

    <footer class="app-footer" aria-label="Debug local storage">
        <div class="footer-title">LocalStorage: <code>infoEtfState</code> (raw)</div>
        <textarea id="infoEtfStateRaw" class="footer-raw" rows="3" spellcheck="false"></textarea>
    </footer>

    <script src="InfoEtf.js"></script>
</body>
</html>